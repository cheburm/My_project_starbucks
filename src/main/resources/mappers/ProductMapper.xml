<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.springboot.starbucks.domain.admin.ProductRepository">

<select id="getProductByProductCategoryName" parameterType="String" resultType="com.springboot.starbucks.domain.admin.Product">
	select
		pi.product_code,
		product_categoryName,
		product_name,
		product_price,
		product_img
	from
		product_categorys pc
		LEFT outer join product_info pi on(pi.product_code = pc.product_code)
	where
		pc.product_categoryName = #{productCategoryName};
</select>

<select id="getProductByProductCategoryAll" parameterType="String" resultType="com.springboot.starbucks.domain.admin.Product">
	select
		pi.product_code,
		product_categoryName,
		product_name,
		product_price,
		product_img
	from
		product_categorys pc
		LEFT outer join product_info pi on(pi.product_code = pc.product_code)
	group by 
		product_name;
</select>

<select id="getProductByProductDtl" parameterType="Integer" resultType="com.springboot.starbucks.domain.admin.Product">
	select
		pi.product_code,
		pi.product_name,
		pi.product_price,
		pi.product_img,
		pdi.product_introduction_img
	from
		product_info pi
		LEFT OUTER JOIN productdtl_info pdi ON(pi.product_code = pdi.product_code)
	where
		pi.product_code = #{product_code};
</select>

<select id="getProductByProduct" resultType="com.springboot.starbucks.domain.admin.Product">
	select
		product_code,
		product_name,
		product_img
	from
		product_info
	where
		product_code = #{product_code};
</select>

<sql id="auto_increment__review_code">
	select
		ifnull(max(review_code), 0) + 1
	from
		product_review;
</sql>
<insert id="insertProductReview" parameterType="com.springboot.starbucks.domain.admin.ProductDtl">
<selectKey keyProperty="review_code" resultType="Integer" order="BEFORE"> 
	<include refid="auto_increment__review_code"></include>
</selectKey>
	insert into
		product_review
	values(
		#{review_code},
		#{product_code},
		#{user_id},
		#{total_score},
		#{review_write},
		now(),
		now()
		);
	insert into
		product_review_file
	values
<foreach collection="review_files" item="review_file" separator=",">
		(
		0,
		#{review_code},
		#{review_file},
		now(),
		now()
		)
</foreach>
;
</insert>


<select id="getProductDtlByProductDtl" parameterType="Integer" resultType="com.springboot.starbucks.domain.admin.ProductDtl">
select
	pr.review_code,
	pr.product_code,
	pr.user_id,
	um.username,
	pr.total_score,
	pr.review_write,
	pr.create_date,
	prf.review_file
from
	product_review pr
	LEFT OUTER JOIN product_review_file prf ON(prf.review_code = pr.review_code)
	LEFT OUTER JOIN user_mst um ON(um.id = pr.user_id)
where
	pr.product_code = #{product_code};
</select>

</mapper>











